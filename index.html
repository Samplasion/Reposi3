<!DOCTYPE html>
<html lang="en">
<head>
  <title>Samplasion's Repo</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="depictions/ios7.min.css">
  <link rel="stylesheet" href="depictions/common.css">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script type="text/javascript" src="depictions/ios7.min.js"></script>

  <style>
  article section.content ul li h4, article section.content ul li h3 {
    margin-block-end: 10px;
    margin-block-start: 9px;
  }
  .has-subpixel .subpixel-line, .has-subpixel body>header:after, .has-subpixel hr, .has-subpixel ul li:after, .has-subpixel ul:after, .has-subpixel ul:before, ul .has-subpixel li:after {
    height: 1px;
  }

  article p[role=footer] {
    margin-top: -30px !important;
  }
  </style>
</head>
<body>

<header role="banner">
  <h1>Samplasion's Repo</h1>
</header>

<main id="content" role="main">
  <article class="panel panel-default">
    <section class="content">
      <ul>
        <li><h3 class="panel-heading">Samplasion's repo</h3> is my Cydia repository</li>
        <li><a href="cydia://url/https://cydia.saurik.com/api/share#?source=https://samplasion.github.io/cydia/" role="button">Add to Cydia</a></li>
      </ul>
    </section>
    <p role="footer">Psst: removing "/cydia" from the URL will take you to my blog!</p>
  </article>

  <article class="panel panel-default">
    <header><h2>Hosted Packages</h2></header>
  </article>

  <div id="tweakslist">
  </div>
</main>

<script>
function readTextFile(file) {
  return new Promise((res, rej) => {
    var rawFile = new XMLHttpRequest();
    rawFile.open("GET", file, false);
    rawFile.onreadystatechange = function () {
        if(rawFile.readyState === 4) {
            if(rawFile.status === 200 || rawFile.status == 0) {
                var allText = rawFile.responseText;
                res(allText);
            }
        }
    }
    rawFile.send(null);
    setTimeout(() => rej(""), 10000)
  })
}

readTextFile("http://www.samplasion.tk/cydia/Packages").then(text => {

  var packages = text.split("\n\n")

  const sort = (a, b) => {
    var metadataA = a
    // a.split("\n").forEach(pm => {
    //   metadataA[pm.split(": ")[0]] = pm.split(": ")[1]
    // })
    var metadataB = b
    // b.split("\n").forEach(pm => {
    //   metadataB[pm.split(": ")[0]] = pm.split(": ")[1]
    // })

    return metadataA.Name.localeCompare(metadataB.Name)
  }

  var processedPackages = {}

  const isHigher = (verA, /* > */ verB) => {
    if (verA.includes("+debug") && !verB.includes("+debug")) return false;
    if (verB.includes("+debug") && !verA.includes("+debug")) return true;

    var verASplit = verA.split(".")
    var verBSplit = verB.split(".")

    // eg. version 1 vs. version 0.9
    if (parseInt(verASplit[0]) > parseInt(verBSplit[0])) return true
    // eg. version 0.9 vs. version 1
    else if (parseInt(verASplit[0]) < parseInt(verBSplit[0])) return false
    // eg. version 1.1 vs. version 1.0
    else if ((parseInt(verASplit[0]) == parseInt(verBSplit[0])) && parseInt(verASplit[1]) > parseInt(verBSplit[1])) return true
    // eg. version 1.0 vs. version 1.1
    else if ((parseInt(verASplit[0]) == parseInt(verBSplit[0])) && parseInt(verASplit[1]) < parseInt(verBSplit[1])) return false
    // eg. version 1.0.1 vs. version 1.0.2
    else if ((parseInt(verASplit[0]) == parseInt(verBSplit[0])) && (parseInt(verASplit[1] || 0) == parseInt(verBSplit[1] || 0)) && (parseInt(verASplit[2] || 0) > parseInt(verBSplit[2] || 0))) return true
    // eg. version 1.0.1 vs. version 1.0.0
    else if ((parseInt(verASplit[0]) == parseInt(verBSplit[0])) && (parseInt(verASplit[1] || 0) == parseInt(verBSplit[1] || 0)) && (parseInt(verASplit[2] || 0) < parseInt(verBSplit[2] || 0))) return false

    return false
  }

  const populateProcessedPackagesWithPackage = package => {
    var metadata = {}
    package.split("\n").forEach(pm => {
      metadata[pm.split(": ")[0]] = pm.split(": ")[1]
    })

    if (!(metadata.Package in processedPackages)) {
      processedPackages[metadata.Package] = metadata
      return true;
    } else {
      if (!isHigher(processedPackages[metadata.Package].Version, metadata.Version)) {
        // this package is newer than the same, processed package
        processedPackages[metadata.Package] = metadata
        return true
      }
    }

    return false;
  }

  packages.forEach(populateProcessedPackagesWithPackage);

  Object.values(processedPackages).sort(sort).forEach(package => {
    var metadata = {}
    package.split("\n").forEach(pm => {
      metadata[pm.split(": ")[0]] = pm.split(": ")[1]
    })

    var div = $("<div>")
    div.html(`
      <article class="panel panel-default">
  	  <section class="content"><ul><li><h4 class="panel-heading">${metadata.Name} ${metadata.Version}</h4>
    ${metadata.Description}</li><li>
    <a class="btn btn-xs btn-default" href="${metadata.Depiction}" role="button">More info</a></li></ul>
  	  </section>
      </article>
      `)
    div.addClass("panel")
    div.addClass("panel-default")
    $("#tweakslist").append(div)
  })
})
</script>

</body>
</html>
